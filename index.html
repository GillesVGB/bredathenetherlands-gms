<!DOCTYPE html>

<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMS Breda - Gemeentelijk Meldingen Systeem</title>
    <style>
        :root {
            --primary: #0c1e3e;
            --secondary: #1a3a5f;
            --accent: #4a9eff;
            --urgent: #ff4757;
            --online: #2ed573;
            --offline: #ff6b6b;
            --admin: #9b59b6;
            --warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LOGIN SCREEN */
        #loginScreen {
            background: rgba(26, 45, 79, 0.95);
            border-radius: 15px;
            padding: 50px;
            max-width: 450px;
            margin: 100px auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            text-align: center;
            border: 1px solid #2a4270;
        }

        .login-title {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            background: #0f2447;
            border: 2px solid #2a4270;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #3a8eff;
            transform: translateY(-2px);
        }

        /* HEADER */
        header {
            background: rgba(26, 45, 79, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #2a4270;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--accent);
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-bottom: 1px solid #2a4270;
            padding-bottom: 10px;
        }

        .nav-tab {
            padding: 10px 25px;
            background: #2a4270;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .nav-tab.active {
            background: var(--accent);
        }

        .nav-tab.admin {
            background: var(--admin);
        }

        /* MAIN CONTENT */
        #mainContent {
            display: none;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* MAIN GRID */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            min-height: 70vh;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* CARDS */
        .card {
            background: rgba(26, 45, 79, 0.9);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid var(--accent);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: var(--accent);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* DIENSTEN OVERZICHT */
        .status-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #2a4270;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: var(--accent);
        }

        /* ROEPNUMMER CARD */
        .roepnummer-card {
            background: rgba(26, 45, 79, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .roepnummer-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .roepnummer-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .roepnummer-text {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .roepnummer-naam {
            color: #88c1ff;
            font-size: 0.9rem;
        }

        .status-indicator {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-in {
            background: var(--online);
            color: white;
        }

        .status-out {
            background: var(--offline);
            color: white;
        }

        .status-busy {
            background: var(--warning);
            color: white;
        }

        /* SPRAAKVERZOEKEN FORM */
        .spraakverzoek-form {
            background: rgba(15, 36, 71, 0.9);
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #2a4270;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: bold;
        }

        select, textarea, input {
            width: 100%;
            padding: 12px;
            background: #0a1a35;
            border: 2px solid #2a4270;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .urgent-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #3a8eff;
            transform: translateY(-2px);
        }

        .submit-btn.urgent {
            background: var(--urgent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* SPRAAKVERZOEKEN LIJST */
        .spraakverzoeken-lijst {
            overflow-y: auto;
            max-height: 400px;
            margin-top: 20px;
        }

        .spraak-item {
            background: rgba(15, 36, 71, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--accent);
            transition: all 0.3s;
        }

        .spraak-item.urgent {
            border-left-color: var(--urgent);
            background: rgba(255, 71, 87, 0.1);
        }

        .spraak-item.pending {
            border-left-color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }

        .spraak-item.resolved {
            border-left-color: var(--online);
            opacity: 0.7;
        }

        .spraak-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .spraak-type {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .spraak-prio {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .prio-1 { background: var(--urgent); color: white; }
        .prio-2 { background: #ff9f43; color: white; }
        .prio-3 { background: #2ed573; color: white; }

        .spraak-details {
            color: #88c1ff;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .spraak-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #a8c2ff;
            padding-top: 10px;
            border-top: 1px solid #2a4270;
        }

        .melding-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-accept {
            background: var(--online);
            color: white;
        }

        .btn-decline {
            background: var(--offline);
            color: white;
        }

        .btn-ignore {
            background: #7f8c8d;
            color: white;
        }

        .btn-dispatch {
            background: var(--warning);
            color: white;
        }

        /* DISCORD CARD */
        .discord-card {
            border-left: 5px solid #7289da;
        }

        .kanaal-lijst {
            margin-top: 20px;
        }

        .kanaal-item {
            background: rgba(15, 36, 71, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* DIENSTREGISTRATIE */
        .registratie-card {
            border-left: 5px solid #4caf50;
        }

        .registratie-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(15, 36, 71, 0.9);
            border-radius: 10px;
        }

        .status-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-circle {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .status-circle.online {
            background: var(--online);
            box-shadow: 0 0 10px var(--online);
        }

        .status-circle.offline {
            background: var(--offline);
        }

        .status-circle.busy {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }

        .registratie-form {
            background: rgba(15, 36, 71, 0.9);
            padding: 20px;
            border-radius: 10px;
        }

        .roepnummer-select {
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: var(--accent);
            color: white;
        }

        .action-btn.primary:hover:not(:disabled) {
            background: #3a8eff;
        }

        .action-btn.secondary {
            background: #2a4270;
            color: white;
        }

        .action-btn.secondary:hover:not(:disabled) {
            background: #1e3360;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dienst-timer {
            margin-top: 20px;
            padding: 20px;
            background: rgba(15, 36, 71, 0.9);
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .dienst-timer.show {
            display: block;
        }

        /* ADMIN PANEL */
        .admin-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .admin-panel {
                grid-template-columns: 1fr;
            }
        }

        .admin-form {
            background: rgba(26, 45, 79, 0.9);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid var(--admin);
        }

        .admin-form h2 {
            color: var(--admin);
            margin-bottom: 20px;
        }

        .admin-list {
            margin-top: 20px;
        }

        .admin-item {
            background: rgba(15, 36, 71, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: var(--urgent);
            color: white;
        }

        /* DISCORD SETTINGS */
        .discord-settings {
            background: rgba(26, 45, 79, 0.9);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #7289da;
        }

        .discord-info {
            background: rgba(15, 36, 71, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #88c1ff;
        }

        /* DISPATCH MODAL */
        .dispatch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .dispatch-modal.show {
            display: flex;
        }

        .dispatch-content {
            background: var(--secondary);
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            border: 2px solid var(--warning);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dispatch-options {
            margin: 20px 0;
        }

        .dispatch-option {
            background: rgba(15, 36, 71, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dispatch-checkbox {
            width: 20px;
            height: 20px;
        }

        /* FOOTER */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #88c1ff;
            border-top: 1px solid #2a4a7a;
            font-size: 0.9rem;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--secondary);
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--accent);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            #loginScreen {
                margin: 20px;
                padding: 30px;
            }

            .header-top {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .main-grid {
                gap: 15px;
            }

            .card, .admin-form, .discord-settings {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-title">
            <span>üö®</span>
            <span>GMS BREDA</span>
        </div>
        <p style="color: #88c1ff; margin-bottom: 30px;">Gemeentelijk Meldingen Systeem</p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="E-mailadres" value="admin@reghaag.nl">
        <input type="password" id="loginPassword" class="login-input" placeholder="Wachtwoord" value="welkom123">
        
        <button class="login-btn" onclick="login()">
            üîê Inloggen
        </button>
        
        <p style="margin-top: 25px; color: #88c1ff; font-size: 0.9rem;">
            <i>Default admin: admin@reghaag.nl / welkom123</i>
        </p>
    </div>

    <!-- MAIN DASHBOARD (hidden by default) -->
    <div id="mainContent" class="container">
        <!-- HEADER -->
        <header>
            <div class="header-top">
                <h1>üö® GMS BREDA Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div>
                        <div id="currentUser">admin@reghaag.nl</div>
                        <div id="userRole" style="color: #88c1ff; font-size: 0.9rem;">Admin</div>
                    </div>
                    <button class="action-btn secondary" onclick="logout()" style="width: auto;">
                        üö™ Uitloggen
                    </button>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="nav-tab admin" onclick="switchTab('admin')" id="adminTab" style="display: none;">üëë Admin</button>
                <button class="nav-tab" onclick="switchTab('discord')">üéÆ Discord</button>
            </div>
        </header>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="main-grid">
                <!-- LEFT PANEL -->
                <div class="left-panel">
                    <!-- DIENSTEN OVERZICHT -->
                    <div class="card">
                        <h2>üë• Actieve Diensten</h2>
                        <div class="status-filter">
                            <button class="filter-btn active" onclick="filterStatus('alle')">Alle</button>
                            <button class="filter-btn" onclick="filterStatus('in')">Vrij</button>
                            <button class="filter-btn" onclick="filterStatus('busy')">Bezig</button>
                            <button class="filter-btn" onclick="filterStatus('uit')">Uit</button>
                        </div>
                        
                        <div id="roepnummersLijst">
                            <!-- Roepnummers worden hier ingeladen -->
                            <p style="color: #88c1ff; text-align: center; padding: 20px;">
                                Geen roepnummers gevonden. Voeg eerst gebruikers toe in het Admin paneel.
                            </p>
                        </div>
                    </div>

                    <!-- SPRAAKVERZOEKEN -->
                    <div class="card">
                        <h2>üì° Nieuw Spraakverzoek</h2>
                        
                        <div class="spraakverzoek-form">
                            <form id="spraakverzoekForm">
                                <div class="form-group">
                                    <label for="spraakType">Type Spraakverzoek</label>
                                    <select id="spraakType" required onchange="updateDienstOptions()">
                                        <option value="">Selecteer type...</option>
                                        <option value="URGENTIE">üö® URGENTIE (Prioriteit 1)</option>
                                        <option value="BIJSTAND">üÜò BIJSTAND (Prioriteit 2)</option>
                                        <option value="ALGEMEEN">üìû ALGEMEEN (Prioriteit 3)</option>
                                        <option value="INFORMATIE">‚ÑπÔ∏è INFORMATIE (Prioriteit 4)</option>
                                        <option value="STATUS">üìä STATUS (Prioriteit 5)</option>
                                        <option value="TERUGMELDING">‚úÖ TERUGMELDING (Prioriteit 3)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="spraakDienst">Voor Dienst</label>
                                    <select id="spraakDienst" required>
                                        <option value="">Selecteer dienst...</option>
                                        <option value="alle">Alle Diensten</option>
                                        <option value="politie">üëÆ Politie</option>
                                        <option value="brandweer">üöí Brandweer</option>
                                        <option value="ambulance">üöë Ambulance</option>
                                        <option value="kmar">ü™ñ KMar</option>
                                        <option value="dsi">üî´ DSI</option>
                                        <option value="meldkamer">üì° Meldkamer</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="spraakBericht">Bericht / Omschrijving</label>
                                    <textarea id="spraakBericht" rows="4" placeholder="Beschrijf het spraakverzoek..." required></textarea>
                                </div>

                                <div class="urgent-checkbox">
                                    <input type="checkbox" id="isUrgent">
                                    <label for="isUrgent" style="color: var(--urgent); font-weight: bold;">
                                        üö® DIT IS EEN URGENT SPRAAKVERZOEK!
                                    </label>
                                </div>

                                <button type="submit" class="submit-btn" id="submitSpraak">
                                    üì¢ Spraakverzoek Indienen
                                </button>
                            </form>
                        </div>

                        <!-- SPRAAKVERZOEKEN LIJST -->
                        <div style="margin-top: 30px;">
                            <h3 style="color: var(--accent); margin-bottom: 15px;">üìã Recente Spraakverzoeken</h3>
                            <div class="spraakverzoeken-lijst" id="spraakLijst">
                                <p style="color: #88c1ff; text-align: center; padding: 20px;">
                                    Nog geen spraakverzoeken ingediend.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL -->
                <div class="right-panel">
                    <!-- DISCORD KANALEN -->
                    <div class="card discord-card">
                        <h2>üéÆ Discord Kanalen</h2>
                        <p style="color: #a8c2ff; margin: 10px 0 20px 0;">
                            Live bezetting van alle spreekkanalen
                        </p>
                        
                        <div class="kanaal-lijst" id="discordKanalen">
                            <p style="color: #88c1ff; text-align: center; padding: 20px;">
                                Discord kanalen worden hier getoond.<br>
                                Configureer in Discord tab.
                            </p>
                        </div>
                    </div>

                    <!-- DIENSTREGISTRATIE -->
                    <div class="card registratie-card">
                        <h2>‚è∞ Dienstregistratie</h2>

                        <div class="registratie-status">
                            <div class="status-display">
                                <div class="status-circle offline" id="statusCircle"></div>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.2rem;" id="currentStatus">Uit Dienst</div>
                                    <div style="color: #88c1ff; font-size: 0.9rem;" id="currentRoepnummer">-</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #88c1ff; font-size: 0.9rem;">Huidige sessie</div>
                                <div style="font-weight: bold;" id="currentTimer">00:00:00</div>
                            </div>
                        </div>

                        <div class="registratie-form">
                            <select class="roepnummer-select" id="selectRoepnummer">
                                <option value="">Selecteer je roepnummer...</option>
                                <!-- Roepnummers worden hier ingevuld -->
                            </select>

                            <div class="action-buttons">
                                <button class="action-btn primary" id="startDienstBtn" onclick="startDienst()">
                                    ‚ñ∂ Start Dienst
                                </button>
                                <button class="action-btn secondary" id="stopDienstBtn" onclick="stopDienst()" disabled>
                                    ‚èπ Stop Dienst
                                </button>
                            </div>

                            <div class="dienst-timer" id="dienstTimer">
                                <div style="color: #88c1ff;">Dienst gestart om:</div>
                                <div class="timer-display" id="startTijdDisplay">--:--</div>
                                <div style="color: #88c1ff; margin-top: 15px;">
                                    <i>Bij uitklokken wordt de tijd naar Discord verzonden</i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN TAB (alleen voor admins) -->
        <div id="tab-admin" class="tab-content">
            <div class="admin-panel">
                <!-- GEBRUIKERS BEHEREN -->
                <div class="admin-form">
                    <h2>üë§ Nieuwe Gebruiker Toevoegen</h2>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newEmail">E-mailadres</label>
                            <input type="email" id="newEmail" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">Wachtwoord</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newName">Naam</label>
                            <input type="text" id="newName" required placeholder="Bijv. Jan Jansen">
                        </div>
                        
                        <div class="form-group">
                            <label for="newDienst">Dienst</label>
                            <select id="newDienst" required>
                                <option value="">Selecteer dienst...</option>
                                <option value="politie">üëÆ Politie</option>
                                <option value="brandweer">üöí Brandweer</option>
                                <option value="ambulance">üöë Ambulance</option>
                                <option value="kmar">ü™ñ KMar</option>
                                <option value="dsi">üî´ DSI</option>
                                <option value="meldkamer">üì° Meldkamer</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="newRoepnummer">Roepnummer</label>
                            <input type="text" id="newRoepnummer" required placeholder="Bijv. P-12, BH-101">
                        </div>
                        
                        <div class="form-group">
                            <label for="newRole">Rol</label>
                            <select id="newRole" required>
                                <option value="gebruiker">üë§ Gebruiker</option>
                                <option value="meldkamer">üì° Meldkamer</option>
                                <option value="admin">üëë Admin</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            ‚ûï Gebruiker Toevoegen
                        </button>
                    </form>
                </div>

                <!-- GEBRUIKERS LIJST -->
                <div class="admin-form">
                    <h2>üìã Alle Gebruikers</h2>
                    <div class="admin-list" id="usersList">
                        <!-- Gebruikers worden hier ingeladen -->
                        <p style="color: #88c1ff; text-align: center; padding: 20px;">
                            Nog geen gebruikers toegevoegd.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISCORD TAB -->
        <div id="tab-discord" class="tab-content">
            <div class="discord-settings">
                <h2>üîß Discord Instellingen</h2>
                
                <div class="form-group">
                    <label for="discordWebhook">Discord Webhook URL</label>
                    <input type="text" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
                    <p style="color: #88c1ff; font-size: 0.9rem; margin-top: 5px;">
                        <i>Deze URL is nodig om berichten naar Discord te sturen</i>
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="discordBotNaam">Bot Naam</label>
                    <input type="text" id="discordBotNaam" value="GMS Bot" placeholder="Naam die in Discord verschijnt">
                </div>
                
                <button class="submit-btn" onclick="saveDiscordSettings()">
                    üíæ Instellingen Opslaan
                </button>
                
                <div class="discord-info">
                    <h4>üìñ Hoe krijg ik een Discord Webhook?</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Ga naar je Discord server</li>
                        <li>Kanaal instellingen ‚Üí "Integrations"</li>
                        <li>Klik "Webhooks" ‚Üí "New Webhook"</li>
                        <li>Kopieer de Webhook URL</li>
                        <li>Plak hierboven</li>
                    </ol>
                    <button class="action-btn secondary" onclick="testDiscordWebhook()" style="width: 100%; margin-top: 10px;">
                        üß™ Test Discord Webhook
                    </button>
                </div>
            </div>
        </div>

<footer>
    <p>GMS Breda v4.0 | Gemeentelijk Meldingen Systeem | ¬© 2024</p>
    <p style="margin-top: 10px;">
        <!-- Bestaande knoppen -->
        <button onclick="resetAllData()" class="action-btn secondary" style="width: auto;">
            üî• Alles Resetten
        </button>
        <button onclick="exportData()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üíæ Exporteer Data
        </button>
        <button onclick="importData()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üì• Importeer Data
        </button>
        <button onclick="backupToFile()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üíæ Maak Backup
        </button>
        <button onclick="restoreFromFile()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üì• Herstel Backup
        </button>
        <button onclick="testLogin()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üêõ Test Gebruikers
        </button>
        
        <!-- NIEUWE TEST KNOppen -->
        <button onclick="testMeldingenAPI()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üß™ Test Meldingen API
        </button>
        <button onclick="testAllAPIs()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üß™ Test Alle APIs
        </button>
        <button onclick="forceReloadData()" class="action-btn secondary" style="width: auto; margin-left: 10px;">
            üîÑ Force Reload
        </button>
    </p>
</footer>
    </div>

    <!-- STATUS MODAL -->
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <h2 style="color: var(--accent); margin-bottom: 20px;">üîÑ Status Wijzigen</h2>
            <p id="modalRoepnummer" style="color: white; font-size: 1.2rem; margin-bottom: 30px;"></p>
            
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button onclick="changeStatus('in')" style="padding: 15px 30px; background: var(--online); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                    ‚úÖ VRIJ
                </button>
                <button onclick="changeStatus('busy')" style="padding: 15px 30px; background: var(--warning); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                    üö® BEZIG
                </button>
                <button onclick="changeStatus('uit')" style="padding: 15px 30px; background: var(--offline); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                    ‚ùå UIT
                </button>
            </div>
            
            <button onclick="closeModal()" style="margin-top: 30px; width: 100%; padding: 12px; background: #2a4270; border: none; border-radius: 8px; color: white; cursor: pointer;">
                Annuleren
            </button>
        </div>
    </div>

    <!-- DISPATCH MODAL -->
    <div class="dispatch-modal" id="dispatchModal">
        <div class="dispatch-content">
            <h2 style="color: var(--warning); margin-bottom: 20px;">üö® Eenheden Uitzenden</h2>
            <p id="dispatchMelding" style="color: white; font-size: 1.1rem; margin-bottom: 20px;"></p>
            
            <div class="dispatch-options" id="dispatchOptions">
                <!-- Eenheden worden hier ingeladen -->
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button onclick="dispatchSelected()" class="action-btn primary" style="flex: 1;">
                    ‚úÖ Uitzenden
                </button>
                <button onclick="declineMelding()" class="action-btn secondary" style="flex: 1;">
                    ‚ùå Afwijzen
                </button>
                <button onclick="ignoreMelding()" class="action-btn" style="flex: 1; background: #7f8c8d;">
                    ‚ûñ Negeren
                </button>
            </div>
            
            <button onclick="closeDispatchModal()" style="margin-top: 20px; width: 100%; padding: 12px; background: #2a4270; border: none; border-radius: 8px; color: white; cursor: pointer;">
                Annuleren
            </button>
        </div>
    </div>

    <script>
        function getAPIUrl(endpoint) {
  // Gebruik altijd .netlify/functions
  return `/.netlify/functions${endpoint}`;
}



        // ======================
// REALTIME SYNC FUNCTIES
// ======================

let syncInterval = null;
let lastMeldingId = null;

async function loadUsersFromServer() {
    try {
        console.log("üì• Gebruikers laden van server...");
        const response = await fetch(getAPIUrl('/sync-users'));
        const data = await response.json();
        
        if (data.users && data.users.length > 0) {
            console.log(`‚úÖ ${data.users.length} gebruikers van server`);
            
            data.users.forEach(serverUser => {
                const localIndex = users.findIndex(u => u.email === serverUser.email);
                
                if (localIndex === -1) {
                    // Nieuwe gebruiker
                    users.push(serverUser);
                    console.log('‚ûï Nieuwe gebruiker:', serverUser.email);
                } else {
                    // Update status van bestaande
                    users[localIndex].status = serverUser.status;
                }
            });
            
            updateUsersList();
            updateRoepnummersFromUsers();
            updateRoepnummerSelect();
            saveToLocalStorage();
        }
    } catch (error) {
        console.error('‚ùå Fout bij laden gebruikers:', error);
    }
}

function startRealtimeSync() {
    if (syncInterval) clearInterval(syncInterval);
    
    console.log("üîÑ Start realtime sync (elke 10 seconden)");
    
    syncInterval = setInterval(async () => {
        if (!currentUser) return;
        
        try {
            await loadUsersFromServer();
            await loadMeldingenFromAPI();
            
            if (['admin', 'meldkamer'].includes(currentUser.role)) {
                checkForNewMeldingen();
            }
            
        } catch (error) {
            console.error('Sync error:', error);
        }
    }, 10000);
}

function checkForNewMeldingen() {
    if (spraakverzoeken.length === 0) return;
    
    const latestMelding = spraakverzoeken[0];
    
    if (lastMeldingId !== latestMelding.id) {
        lastMeldingId = latestMelding.id;
        
        // Maak notificatie
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; 
            background: linear-gradient(135deg, #ff4757, #ff6b6b);
            color: white; padding: 15px 25px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 9999;
            animation: slideIn 0.3s ease-out; border-left: 5px solid white;
            min-width: 300px; max-width: 400px;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="font-size: 1.5rem;">üö®</span>
                <strong style="font-size: 1.1rem;">Nieuwe melding</strong>
            </div>
            <div style="font-size: 0.95rem;">${latestMelding.type}</div>
            <div style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7; text-align: right;">
                ${new Date().toLocaleTimeString('nl-NL', {hour: '2-digit', minute:'2-digit'})}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
        
        notification.onclick = () => notification.remove();
    }
}

// Voeg CSS toe
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

function testAllAPIs() {
  console.log('üß™ Test alle APIs...');
  
  Promise.all([
    fetch(getAPIUrl('/sync-users')).then(r => r.json()),
    fetch(getAPIUrl('/get-meldingen')).then(r => r.json()),
    fetch(getAPIUrl('/add-melding'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'TEST',
        dienst: 'politie',
        bericht: 'Test melding van API',
        urgent: false,
        prioriteit: 3,
        tijd: new Date().toLocaleTimeString('nl-NL'),
        datum: new Date().toISOString().split('T')[0]
      })
    }).then(r => r.json())
  ])
  .then(results => {
    console.log('API Results:', results);
    alert(`‚úÖ Alle APIs werken!\n\nGebruikers: ${results[0].users?.length || 0}\nMeldingen: ${results[1].meldingen?.length || 0}`);
  })
  .catch(error => {
    console.error('‚ùå API test mislukt:', error);
    alert(`‚ùå API test mislukt:\n${error.message}`);
  });
}

function forceReloadData() {
    if (confirm("Weet je zeker dat je alle data wilt herladen?\n\nDit logt je uit en herlaadt alles van de server.")) {
        // Stop sync
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
        
        // Clear localStorage
        localStorage.removeItem('gms_data');
        localStorage.removeItem('gms_currentUser');
        
        // Herlaad pagina
        location.reload();
    }
}
        // FUNCTIE: LAAD MELDINGEN VAN NETLIFY FUNCTION
async function loadMeldingenFromAPI() {
    try {
        console.log("üì• Meldingen laden van API...");
        
        const response = await fetch(getAPIUrl('/get-meldingen'));
        const data = await response.json();
        
        if (data.meldingen && data.meldingen.length > 0) {
            console.log(`‚úÖ ${data.meldingen.length} meldingen geladen van API`);
            
            // Merge met lokale meldingen
            data.meldingen.forEach(apiMelding => {
                const exists = spraakverzoeken.find(m => m.id === apiMelding.id);
                if (!exists) {
                    spraakverzoeken.push(apiMelding);
                }
            });
            
            loadSpraakverzoeken();
            saveToLocalStorage();
        }
        
    } catch (error) {
        console.error("‚ùå Fout bij laden meldingen:", error);
    }
}

// FUNCTIE: MELDING TOEVOEGEN VIA API
async function addMeldingViaAPI(meldingData) {
    try {
            const response = await fetch(getAPIUrl('/add-melding'), { // ‚Üê NIEUWE URL
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(meldingData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            console.log("‚úÖ Melding toegevoegd via API:", result);
            return result.melding;
        } else {
            console.error("‚ùå API error:", result);
            return null;
        }
        
    } catch (error) {
        console.error("‚ùå Netwerk error bij toevoegen melding:", error);
        return null;
    }
}

// FUNCTIE: UPDATE MELDING VIA API
async function updateMeldingViaAPI(meldingId, updates) {
    try {
        // Maak een update-melding functie in Netlify
        const response = await fetch('/.netlify/functions/update-melding', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: meldingId, ...updates })
        });
        
        return await response.json();
        
    } catch (error) {
        console.error("‚ùå Update melding error:", error);
        return null;
    }
}
        // GLOBALE VARIABELEN
        // ======================
// GIT SYNC CONFIGURATIE
// ======================


// SYNC BIJ OPSTARTEN (3 seconden na laden)

        let currentUser = null;
        let users = [
            {
                id: 1,
                email: 'admin@reghaag.nl',
                password: 'welkom123',
                name: 'Admin User',
                dienst: 'meldkamer',
                roepnummer: 'MK-01',
                role: 'admin',
                status: 'in'
            }
        ];

        let roepnummers = [];
        let spraakverzoeken = [];
        let discordKanalen = [];
        let discordSettings = {
            webhookURL: '',
            botNaam: 'GMS Bot'
        };

        let huidigeDienst = null;
        let dienstStartTijd = null;
        let dienstTimer = null;
        let selectedRoepnummerId = null;
        let currentDispatchMelding = null;

        // INITIALISATIE
 

 // INITIALISATIE
document.addEventListener('DOMContentLoaded', function() {
    // Laad data uit localStorage
    loadFromLocalStorage();
    
    // Update gebruikerslijst
    updateUsersList();
    
    // Update roepnummers (van gebruikers)
    updateRoepnummersFromUsers();
    
    // Event listeners
    document.getElementById('spraakverzoekForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitSpraakverzoek();
    });

    document.getElementById('addUserForm').addEventListener('submit', addNewUser);

    document.getElementById('isUrgent').addEventListener('change', function() {
        const submitBtn = document.getElementById('submitSpraak');
        if (this.checked) {
            submitBtn.classList.add('urgent');
            submitBtn.innerHTML = 'üö® URGENT SPRAAKVERZOEK INDIENEN';
        } else {
            submitBtn.classList.remove('urgent');
            submitBtn.innerHTML = 'üì¢ Spraakverzoek Indienen';
        }
    });

    // Vul discord instellingen
    document.getElementById('discordWebhook').value = discordSettings.webhookURL;
    document.getElementById('discordBotNaam').value = discordSettings.botNaam;
    
    // ‚úÖ CORRECTE AUTO-SYNC BIJ OPSTARTEN
    setTimeout(() => {
        // Als er al iemand ingelogd is, start sync
        if (currentUser) {
            startRealtimeSync();
            loadUsersFromServer();
            loadMeldingenFromAPI();
        }
    }, 3000);
});
// Voeg deze toe ergens in je script om te testen:
function checkSyncStatus() {
    console.log("=== SYNC STATUS ===");
    console.log("syncInterval actief:", syncInterval ? "JA" : "NEE");
    console.log("Current user:", currentUser ? currentUser.email : "GEEN");
    console.log("Users in systeem:", users.length);
    console.log("Last melding ID:", lastMeldingId);
}
        
// LOGIN FUNCTIE
function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
        alert('Voer email en wachtwoord in');
        return;
    }

    const user = users.find(u => u.email === email && u.password === password);
    
    if (user) {
        currentUser = user;
        
        // Update UI
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        document.getElementById('currentUser').textContent = user.email;
        document.getElementById('userRole').textContent = 
            user.role === 'admin' ? 'üëë Admin' : 
            user.role === 'meldkamer' ? 'üì° Meldkamer' : 'üë§ Gebruiker';
        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        
        // Toon/verberg Admin tab
        const adminTab = document.getElementById('adminTab');
        if (user.role === 'admin' || user.role === 'meldkamer') {
            adminTab.style.display = 'block';
        } else {
            adminTab.style.display = 'none';
        }
        
        // Laad data
        loadRoepnummers();
        loadSpraakverzoeken();
        loadDiscordKanalen();
        updateRoepnummerSelect();
        updateDienstStatus();
        
        // ‚úÖ START REALTIME SYNC HIER
        startRealtimeSync();
        
        alert(`Welkom ${user.name}!`);
        
        // Sla login op in localStorage
        localStorage.setItem('gms_currentUser', JSON.stringify(user));
        
        // ‚úÖ LAAD DATA VAN SERVER NA LOGIN
        setTimeout(() => {
            loadUsersFromServer();
            loadMeldingenFromAPI();
        }, 1000);
        
    } else {
        alert('Ongeldige login gegevens');
    }
}
// LOGOUT FUNCTIE
function logout() {
    if (huidigeDienst && currentUser.roepnummer === huidigeDienst.nummer) {
        if (!confirm('Je bent nog in dienst! Weet je zeker dat je wilt uitloggen?')) {
            return;
        }
        stopDienst();
    }
    
    // ‚úÖ STOP DE SYNC VOORUIT UITLOGGEN
    if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
    }

    currentUser = null;
    localStorage.removeItem('gms_currentUser');
    
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('loginPassword').value = '';
    
    alert('Uitgelogd');
}

        // TAB SWITCHING
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show correct content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

// NIEUWE GEBRUIKER TOEVOEGEN (MET SERVER SYNC)
async function addNewUser(event) {
    event.preventDefault();
    
    const email = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('newPassword').value;
    const name = document.getElementById('newName').value.trim();
    const dienst = document.getElementById('newDienst').value;
    const roepnummer = document.getElementById('newRoepnummer').value.trim();
    const role = document.getElementById('newRole').value;

    if (!email || !password || !name || !dienst || !roepnummer) {
        alert('Vul alle velden in!');
        return;
    }

    // Check of email lokaal al bestaat
    if (users.some(u => u.email === email)) {
        alert('Dit e-mailadres bestaat al (lokaal)!');
        return;
    }

    // Check of roepnummer lokaal al bestaat
    if (users.some(u => u.roepnummer === roepnummer)) {
        alert('Dit roepnummer bestaat al (lokaal)!');
        return;
    }

    const newUser = {
        id: Date.now(),
        email: email,
        password: password,
        name: name,
        dienst: dienst,
        roepnummer: roepnummer,
        role: role,
        status: 'uit'
    };

    // Toon loading
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = 'üì° Verzenden naar server...';
    submitBtn.disabled = true;

    try {
    // 1. Stuur naar Supabase
    const response = await fetch(getAPIUrl('/sync-users'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newUser)
    });
    
    const result = await response.json();  // ‚Üê CORRECT
    
    if (response.ok && result.success) {  // ‚Üê CORRECT: gebruik response, niet serverResult
        // 2. Voeg lokaal toe
        users.push(newUser);
        
        // 3. Update UI
        updateUsersList();
        updateRoepnummersFromUsers();
        updateRoepnummerSelect();
        
        // 4. Reset form
        document.getElementById('addUserForm').reset();
        
        // 5. Sla op
        saveToLocalStorage();
        
        alert(`‚úÖ ${name} toegevoegd!\n\nAndere spelers kunnen NU inloggen met deze account!`);
        
    } else {
        throw new Error(result.error || 'Server error');
    }
    
} catch (error) {
        console.error('Server sync mislukt:', error);
        
        // Fallback: alleen lokaal toevoegen
        users.push(newUser);
        
        updateUsersList();
        updateRoepnummersFromUsers();
        updateRoepnummerSelect();
        
        document.getElementById('addUserForm').reset();
        saveToLocalStorage();
        
        alert(`‚ö†Ô∏è ${name} alleen lokaal toegevoegd.\nServer sync mislukt: ${error.message}\nAndere spelers kunnen NIET inloggen.`);
        
    } finally {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

        // UPDATE GEBRUIKERS LIJST
        function updateUsersList() {
            const container = document.getElementById('usersList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #88c1ff; text-align: center; padding: 20px;">Nog geen gebruikers toegevoegd.</p>';
                return;
            }
            
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'admin-item';
                item.dataset.id = user.id;
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${user.name}</div>
                        <div style="color: #88c1ff; font-size: 0.9rem;">
                            ${user.email} ‚Ä¢ ${getDienstNaam(user.dienst)} ‚Ä¢ ${user.roepnummer}
                        </div>
                        <div style="color: #a8c2ff; font-size: 0.8rem; margin-top: 5px;">
                            Rol: ${user.role === 'admin' ? 'üëë Admin' : user.role === 'meldkamer' ? 'üì° Meldkamer' : 'üë§ Gebruiker'}
                        </div>
                    </div>
                    <div class="admin-actions">
                        ${user.id !== 1 ? `
                            <button class="btn-small btn-edit" onclick="editUser(${user.id})">‚úèÔ∏è</button>
                            <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">üóëÔ∏è</button>
                        ` : '<span style="color: #88c1ff; font-size: 0.8rem;">Main Admin</span>'}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // DELETE USER
        function deleteUser(userId) {
            if (userId === 1) {
                alert('Kan hoofd admin niet verwijderen!');
                return;
            }
            
            if (!confirm('Weet je zeker dat je deze gebruiker wilt verwijderen?')) {
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            // Verwijder ook dienstregistratie als deze gebruiker in dienst is
            if (huidigeDienst && users[userIndex].roepnummer === huidigeDienst.nummer) {
                stopDienst();
            }
            
            users.splice(userIndex, 1);
            
            // Update alles
            updateUsersList();
            updateRoepnummersFromUsers();
            updateRoepnummerSelect();
            
            saveToLocalStorage();
            alert('‚úÖ Gebruiker verwijderd!');
        }

        // EDIT USER (simpele versie)
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const newName = prompt('Nieuwe naam:', user.name);
            if (newName) user.name = newName;
            
            const newRoepnummer = prompt('Nieuw roepnummer:', user.roepnummer);
            if (newRoepnummer) user.roepnummer = newRoepnummer;
            
            const newRole = prompt('Nieuwe rol (gebruiker/meldkamer/admin):', user.role);
            if (newRole && ['gebruiker', 'meldkamer', 'admin'].includes(newRole)) {
                user.role = newRole;
            }
            
            updateUsersList();
            updateRoepnummersFromUsers();
            updateRoepnummerSelect();
            
            saveToLocalStorage();
            alert('‚úÖ Gebruiker bijgewerkt!');
        }

        // UPDATE ROEPNUMMERS VAN GEBRUIKERS
        function updateRoepnummersFromUsers() {
            roepnummers = users.map(user => ({
                id: user.id,
                nummer: user.roepnummer,
                naam: user.name,
                dienst: user.dienst,
                status: user.status || 'uit',
                role: user.role
            }));
        }

        // LAAD ROEPNUMMERS
        function loadRoepnummers() {
            const container = document.getElementById('roepnummersLijst');
            container.innerHTML = '';
            
            if (roepnummers.length === 0) {
                container.innerHTML = '<p style="color: #88c1ff; text-align: center; padding: 20px;">Geen roepnummers gevonden. Voeg eerst gebruikers toe in het Admin paneel.</p>';
                return;
            }
            
            roepnummers.forEach(roep => {
                const card = document.createElement('div');
                card.className = 'roepnummer-card';
                card.dataset.id = roep.id;
                card.dataset.status = roep.status;
                card.dataset.dienst = roep.dienst;
                
                let statusText = 'UIT';
                let statusClass = 'status-out';
                
                if (roep.status === 'in') {
                    statusText = 'VRIJ';
                    statusClass = 'status-in';
                } else if (roep.status === 'busy') {
                    statusText = 'BEZIG';
                    statusClass = 'status-busy';
                }
                
                card.innerHTML = `
                    <div class="roepnummer-info">
                        <div>
                            <div class="roepnummer-text">${roep.nummer}</div>
                            <div class="roepnummer-naam">${roep.naam} ‚Ä¢ ${getDienstNaam(roep.dienst)}</div>
                        </div>
                    </div>
                    <div class="status-indicator ${statusClass}"
                         onclick="openStatusModal(${roep.id})">
                        ${statusText}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // SUBMIT SPRAAKVERZOEK (ASYNC MET API)
        async function submitSpraakverzoek() {
            const type = document.getElementById('spraakType').value;
            const dienst = document.getElementById('spraakDienst').value;
            const bericht = document.getElementById('spraakBericht').value;
            const urgent = document.getElementById('isUrgent').checked;
            
            if (!type || !dienst || !bericht) {
                alert('Vul alle velden in!');
                return;
            }
            
            // Bepaal prioriteit
            let prioriteit = 3;
            if (type === 'URGENTIE') prioriteit = 1;
            else if (type === 'BIJSTAND') prioriteit = 2;
            else if (urgent) prioriteit = 1;
            
            // Nieuwe melding object
            const nieuweMelding = {
                type: type,
                dienst: dienst,
                bericht: bericht,
                urgent: urgent,
                tijd: new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }),
                datum: new Date().toISOString().split('T')[0],
                prioriteit: prioriteit,
                status: 'pending',
                ingediendDoor: currentUser ? currentUser.name : 'Onbekend',
                roepnummer: currentUser ? currentUser.roepnummer : null
            };
            
            // Toon loading
            const submitBtn = document.getElementById('submitSpraak');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'üì° Verzenden...';
            submitBtn.disabled = true;
            
            try {
                // Probeer eerst via API
                const apiResult = await addMeldingViaAPI(nieuweMelding);
                
                if (apiResult) {
                    // API succesvol
                    nieuweMelding.id = apiResult.id || Date.now();
                    nieuweMelding.apiId = apiResult.id;
                    nieuweMelding.source = 'api';
                } else {
                    // API faalde, gebruik lokale ID
                    nieuweMelding.id = spraakverzoeken.length + 1;
                    nieuweMelding.source = 'local';
                }
                
                // Voeg toe aan array
                spraakverzoeken.unshift(nieuweMelding);
                
                // Reload
                loadSpraakverzoeken();
                
                // Reset form
                document.getElementById('spraakverzoekForm').reset();
                document.getElementById('submitSpraak').classList.remove('urgent');
                document.getElementById('submitSpraak').innerHTML = 'üì¢ Spraakverzoek Indienen';
                
                // Sla op
                saveToLocalStorage();
                
                // Success bericht
                alert(`‚úÖ ${apiResult ? 'Melding via API' : 'Melding lokaal'} ingediend!\n\nWacht op goedkeuring van de meldkamer.`);
                
            } catch (error) {
                console.error("‚ùå Fout bij indienen:", error);
                alert('‚ùå Fout bij indienen melding. Probeer opnieuw.');
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        // ACCEPT MELDING
        function acceptMelding(meldingId) {
            const melding = spraakverzoeken.find(m => m.id === meldingId);
            if (!melding) return;
            
            melding.status = 'dispatched';
            
            // Stuur naar Discord als webhook is ingesteld
            if (discordSettings.webhookURL) {
                sendMeldingToDiscord(melding, 'accepted');
            }
            
            // Update UI
            loadSpraakverzoeken();
            saveToLocalStorage();
            
            alert('‚úÖ Melding geaccepteerd!');
        }

        // OPEN DISPATCH MODAL
        function openDispatchModal(meldingId) {
            const melding = spraakverzoeken.find(m => m.id === meldingId);
            if (!melding) return;
            
            currentDispatchMelding = melding;
            
            document.getElementById('dispatchMelding').textContent = 
                `${melding.type} - ${melding.bericht}`;
            
            // Laad beschikbare eenheden
            const optionsContainer = document.getElementById('dispatchOptions');
            optionsContainer.innerHTML = '';
            
            // Toon alleen eenheden van de juiste dienst (of alle bij 'alle')
            const beschikbareEenheden = roepnummers.filter(roep => {
                return (roep.status === 'in' || roep.status === 'busy') && 
                       (melding.dienst === 'alle' || roep.dienst === melding.dienst);
            });
            
            if (beschikbareEenheden.length === 0) {
                optionsContainer.innerHTML = '<p style="color: #88c1ff; text-align: center;">Geen beschikbare eenheden voor deze dienst.</p>';
            } else {
                beschikbareEenheden.forEach(eenheid => {
                    const option = document.createElement('div');
                    option.className = 'dispatch-option';
                    option.innerHTML = `
                        <div>
                            <div style="font-weight: bold;">${eenheid.nummer}</div>
                            <div style="color: #88c1ff; font-size: 0.9rem;">${eenheid.naam} ‚Ä¢ ${getDienstNaam(eenheid.dienst)}</div>
                        </div>
                        <input type="checkbox" class="dispatch-checkbox" value="${eenheid.id}" 
                               ${eenheid.status === 'busy' ? 'disabled' : 'checked'}>
                    `;
                    optionsContainer.appendChild(option);
                });
            }
            
            document.getElementById('dispatchModal').classList.add('show');
        }

        // CLOSE DISPATCH MODAL
        function closeDispatchModal() {
            document.getElementById('dispatchModal').classList.remove('show');
            currentDispatchMelding = null;
        }

        // DISPATCH SELECTED EENHEDEN
        function dispatchSelected() {
            if (!currentDispatchMelding) return;
            
            const geselecteerdeIds = Array.from(document.querySelectorAll('.dispatch-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (geselecteerdeIds.length === 0) {
                alert('Selecteer minimaal √©√©n eenheid!');
                return;
            }
            
            // Update status van geselecteerde eenheden naar 'busy'
            geselecteerdeIds.forEach(id => {
                const roepIndex = roepnummers.findIndex(r => r.id === id);
                if (roepIndex !== -1) {
                    roepnummers[roepIndex].status = 'busy';
                    
                    // Update ook in users array
                    const userIndex = users.findIndex(u => u.roepnummer === roepnummers[roepIndex].nummer);
                    if (userIndex !== -1) {
                        users[userIndex].status = 'busy';
                    }
                }
            });
            
            // Update melding status
            currentDispatchMelding.status = 'dispatched';
            currentDispatchMelding.uitgezondenEenheden = geselecteerdeIds.map(id => {
                const roep = roepnummers.find(r => r.id === id);
                return roep ? roep.nummer : 'Onbekend';
            });
            currentDispatchMelding.dispatchTijd = new Date().toLocaleTimeString('nl-NL');
            
            // Stuur naar Discord
            if (discordSettings.webhookURL) {
                sendDispatchToDiscord(currentDispatchMelding, geselecteerdeIds);
            }
            
            // Update UI
            loadRoepnummers();
            loadSpraakverzoeken();
            closeDispatchModal();
            saveToLocalStorage();
            
            alert(`‚úÖ ${geselecteerdeIds.length} eenheid(en) uitgezonden!`);
        }

        // DECLINE MELDING
        function declineMelding(meldingId) {
            const melding = typeof meldingId === 'number' 
                ? spraakverzoeken.find(m => m.id === meldingId)
                : currentDispatchMelding;
            
            if (!melding) return;
            
            melding.status = 'declined';
            
            // Stuur naar Discord
            if (discordSettings.webhookURL) {
                sendMeldingToDiscord(melding, 'declined');
            }
            
            // Update UI
            loadSpraakverzoeken();
            if (typeof meldingId !== 'number') {
                closeDispatchModal();
            }
            saveToLocalStorage();
            
            alert('‚ùå Melding afgewezen!');
        }

        // IGNORE MELDING
        function ignoreMelding(meldingId) {
            const melding = typeof meldingId === 'number' 
                ? spraakverzoeken.find(m => m.id === meldingId)
                : currentDispatchMelding;
            
            if (!melding) return;
            
            melding.status = 'resolved';
            
            // Update UI
            loadSpraakverzoeken();
            if (typeof meldingId !== 'number') {
                closeDispatchModal();
            }
            saveToLocalStorage();
            
            alert('‚ûñ Melding genegeerd (opgelost zonder actie).');
        }

        // SEND MELDING TO DISCORD
        async function sendMeldingToDiscord(melding, action) {
            if (!discordSettings.webhookURL) return;
            
            let color = 0x3498db;
            let title = 'üìã MELDING GOEDGEKEURD';
            
            if (action === 'declined') {
                color = 0xe74c3c;
                title = '‚ùå MELDING AFGEWEZEN';
            }
            
            const message = {
                embeds: [{
                    title: title,
                    color: color,
                    fields: [
                        { name: "Type", value: melding.type, inline: true },
                        { name: "Prioriteit", value: `PRIO ${melding.prioriteit}`, inline: true },
                        { name: "Voor", value: getDienstNaam(melding.dienst), inline: true },
                        { name: "Bericht", value: melding.bericht, inline: false },
                        { name: "Tijd", value: melding.tijd, inline: true },
                        { name: "Door", value: melding.ingediendDoor || 'Onbekend', inline: true }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: "GMS Breda - Meldkamer" }
                }]
            };

            try {
                await fetch(discordSettings.webhookURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message)
                });
            } catch (error) {
                console.error('‚ùå Discord error:', error);
            }
        }

        // SEND DISPATCH TO DISCORD
        async function sendDispatchToDiscord(melding, eenheidIds) {
            if (!discordSettings.webhookURL) return;
            
            const eenhedenNamen = eenheidIds.map(id => {
                const roep = roepnummers.find(r => r.id === id);
                return roep ? roep.nummer : 'Onbekend';
            }).join(', ');
            
            const message = {
                content: `@here üö® **EENHEDEN UITGEZONDEN**`,
                embeds: [{
                    title: "üö® DISPATCH ORDER",
                    color: 0xf39c12,
                    fields: [
                        { name: "Type", value: melding.type, inline: true },
                        { name: "Prioriteit", value: `PRIO ${melding.prioriteit}`, inline: true },
                        { name: "Uitgezonden eenheden", value: eenhedenNamen, inline: false },
                        { name: "Locatie/Beschrijving", value: melding.bericht, inline: false },
                        { name: "Dispatch tijd", value: melding.dispatchTijd || new Date().toLocaleTimeString('nl-NL'), inline: true }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: "GMS Breda - Meldkamer Dispatch" }
                }]
            };

            try {
                await fetch(discordSettings.webhookURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message)
                });
            } catch (error) {
                console.error('‚ùå Discord error:', error);
            }
        }

        // REST VAN DE FUNCTIES (login, logout, tab switching, etc.) blijven hetzelfde...
        // [Hier zou de rest van je bestaande JavaScript code komen - te lang voor dit bericht]
        // Ik voeg alleen de essenti√´le nieuwe functies toe

        // SAVE DISCORD SETTINGS
        function saveDiscordSettings() {
            discordSettings.webhookURL = document.getElementById('discordWebhook').value.trim();
            discordSettings.botNaam = document.getElementById('discordBotNaam').value.trim();
            
            saveToLocalStorage();
            alert('‚úÖ Discord instellingen opgeslagen!');
        }

        // TEST DISCORD WEBHOOK
        function testDiscordWebhook() {
            if (!discordSettings.webhookURL) {
                alert('Voer eerst een Discord webhook URL in!');
                return;
            }
            
            const testMessage = {
                content: `‚úÖ **GMS Discord Test**\nDit is een testbericht van het GMS systeem.`,
                embeds: [{
                    title: "üß™ Test Geslaagd!",
                    description: "Discord integratie werkt correct.",
                    color: 0x3498db,
                    timestamp: new Date().toISOString(),
                    footer: { text: "GMS Breda Test" }
                }]
            };
            
            fetch(discordSettings.webhookURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testMessage)
            })
            .then(response => {
                if (response.ok) {
                    alert('‚úÖ Testbericht naar Discord verzonden!');
                } else {
                    alert('‚ùå Fout bij verzenden. Controleer je webhook URL.');
                }
            })
            .catch(error => {
                alert('‚ùå Netwerk fout: ' + error.message);
            });
        }

        // RESET ALL DATA
        function resetAllData() {
            if (!confirm('‚ö†Ô∏è WAARSCHUWING!\n\nWeet je zeker dat je ALLE data wilt resetten?\n\nDit verwijdert alle gebruikers, spraakverzoeken en instellingen.')) {
                return;
            }
            
            // Reset alles behalve hoofd admin
            users = [users.find(u => u.id === 1) || users[0]];
            roepnummers = [];
            spraakverzoeken = [];
            discordKanalen = [];
            discordSettings = {
                webhookURL: '',
                botNaam: 'GMS Bot'
            };
            
            huidigeDienst = null;
            dienstStartTijd = null;
            clearInterval(dienstTimer);
            
            // Update alles
            updateUsersList();
            updateRoepnummersFromUsers();
            loadRoepnummers();
            loadSpraakverzoeken();
            loadDiscordKanalen();
            updateRoepnummerSelect();
            updateDienstStatus();
            
            document.getElementById('dienstTimer').classList.remove('show');
            document.getElementById('startDienstBtn').disabled = false;
            document.getElementById('stopDienstBtn').disabled = true;
            
            // Reset form velden
            document.getElementById('discordWebhook').value = '';
            document.getElementById('discordBotNaam').value = 'GMS Bot';
            
            // Sla op
            saveToLocalStorage();
            
            alert('‚úÖ Alle data gereset! Alleen hoofd admin blijft behouden.');
        }

        // EXPORT DATA
        function exportData() {
            const data = {
                users: users,
                roepnummers: roepnummers,
                spraakverzoeken: spraakverzoeken,
                discordKanalen: discordKanalen,
                discordSettings: discordSettings
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gms-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('üì• Data ge√´xporteerd als JSON bestand!');
        }

        // IMPORT DATA
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!confirm(`Weet je zeker dat je data wilt importeren?\n\nDit overschrijft ALLE huidige data.`)) {
                            return;
                        }
                        
                        users = data.users || users;
                        roepnummers = data.roepnummers || roepnummers;
                        spraakverzoeken = data.spraakverzoeken || spraakverzoeken;
                        discordKanalen = data.discordKanalen || discordKanalen;
                        discordSettings = data.discordSettings || discordSettings;
                        
                        // Update alles
                        updateUsersList();
                        updateRoepnummersFromUsers();
                        loadRoepnummers();
                        loadSpraakverzoeken();
                        loadDiscordKanalen();
                        updateRoepnummerSelect();
                        
                        // Sla op
                        saveToLocalStorage();
                        
                        alert('‚úÖ Data succesvol ge√Ømporteerd!');
                    } catch (error) {
                        alert('‚ùå Fout bij importeren: Ongeldig JSON bestand.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // AUTO-SAVE elke 30 seconden
        setInterval(saveToLocalStorage, 30000);

        // HELPER FUNCTIES
        function getDienstNaam(code) {
            const diensten = {
                'politie': 'Politie üëÆ',
                'brandweer': 'Brandweer üöí',
                'ambulance': 'Ambulance üöë',
                'kmar': 'KMar ü™ñ',
                'dsi': 'DSI üî´',
                'meldkamer': 'Meldkamer üì°',
                'alle': 'Alle Diensten'
            };
            return diensten[code] || code;
        }

        // LOCALSTORAGE FUNCTIES
        function saveToLocalStorage() {
            const data = {
                users: users,
                roepnummers: roepnummers,
                spraakverzoeken: spraakverzoeken,
                discordKanalen: discordKanalen,
                discordSettings: discordSettings,
                huidigeDienst: huidigeDienst,
                dienstStartTijd: dienstStartTijd
            };
            
            localStorage.setItem('gms_data', JSON.stringify(data));
        }

function loadFromLocalStorage() {
    console.log("=== LOADING FROM LOCALSTORAGE ===");
    
    try {
        const saved = localStorage.getItem('gms_data');
        console.log("Raw localStorage data:", saved);
        
        if (saved) {
            const data = JSON.parse(saved);
            console.log("Parsed data:", data);
            
            // ALTIJD de data overschrijven
            users = data.users || [];
            roepnummers = data.roepnummers || [];
            spraakverzoeken = data.spraakverzoeken || [];
            discordKanalen = data.discordKanalen || [];
            discordSettings = data.discordSettings || {
                webhookURL: '',
                botNaam: 'GMS Bot'
            };
            
            console.log("‚úÖ Users loaded:", users.length, "gebruikers");
            console.log("Users:", users);
            
            // Herstel dienst als die bezig was
            if (data.huidigeDienst && data.dienstStartTijd) {
                const tijdVerstreken = new Date() - new Date(data.dienstStartTijd);
                if (tijdVerstreken < 24 * 60 * 60 * 1000) { // Max 24 uur
                    huidigeDienst = data.huidigeDienst;
                    dienstStartTijd = new Date(data.dienstStartTijd);
                    
                    // Start timer opnieuw
                    updateTimer();
                    dienstTimer = setInterval(updateTimer, 1000);
                }
            }
        } else {
            console.log("‚ö†Ô∏è Geen data gevonden in localStorage");
        }
    } catch (error) {
        console.error("‚ùå Fout bij laden localStorage:", error);
        // Reset naar defaults
        users = [
            {
                id: 1,
                email: 'admin@reghaag.nl',
                password: 'welkom123',
                name: 'Admin User',
                dienst: 'meldkamer',
                roepnummer: 'MK-01',
                role: 'admin',
                status: 'in'
            }
        ];
    }
    
    console.log("=== EINDE LADEN ===");
    
    // Auto-login als er een gebruiker was ingelogd
    const savedUser = localStorage.getItem('gms_currentUser');
    if (savedUser) {
        try {
            const user = JSON.parse(savedUser);
            const foundUser = users.find(u => u.email === user.email && u.password === user.password);
            if (foundUser) {
                console.log("Auto-login voor:", foundUser.email);
                currentUser = foundUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                document.getElementById('currentUser').textContent = currentUser.email;
                document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'üëë Admin' : 
                                                                  currentUser.role === 'meldkamer' ? 'üì° Meldkamer' : 'üë§ Gebruiker';
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
                
                // Toon/verberg Admin tab
                const adminTab = document.getElementById('adminTab');
                if (currentUser.role === 'admin' || currentUser.role === 'meldkamer') {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }
                
                // Laad data
                loadRoepnummers();
                loadSpraakverzoeken();
                loadDiscordKanalen();
                updateRoepnummerSelect();
                updateDienstStatus();
                
                if (huidigeDienst) {
                    document.getElementById('dienstTimer').classList.add('show');
                    document.getElementById('startDienstBtn').disabled = true;
                    document.getElementById('stopDienstBtn').disabled = false;
                }
            }
        } catch (error) {
            console.error("Auto-login error:", error);
        }
    }
}
// BACKUP NAAR JSON BESTAND
function backupToFile() {
    const data = {
        users: users,
        roepnummers: roepnummers,
        spraakverzoeken: spraakverzoeken,
        discordKanalen: discordKanalen,
        discordSettings: discordSettings,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gms-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Backup gemaakt!\nBestand: ${a.download}`);
}

// RESTORE VAN JSON BESTAND
function restoreFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                
                if (!confirm(`Weet je zeker dat je een backup wilt herstellen?\n\nDit overschrijft ALLE huidige data met data van: ${data.timestamp || 'onbekende datum'}`)) {
                    return;
                }
                
                // Overschrijf alles
                users = data.users || users;
                roepnummers = data.roepnummers || roepnummers;
                spraakverzoeken = data.spraakverzoeken || spraakverzoeken;
                discordKanalen = data.discordKanalen || discordKanalen;
                discordSettings = data.discordSettings || discordSettings;
                
                // Update alles
                updateUsersList();
                updateRoepnummersFromUsers();
                loadRoepnummers();
                loadSpraakverzoeken();
                loadDiscordKanalen();
                updateRoepnummerSelect();
                
                // Sla op
                saveToLocalStorage();
                
                alert(`‚úÖ Backup hersteld!\n${users.length} gebruikers geladen`);
                location.reload(); // Herlaad de pagina
                
            } catch (error) {
                alert('‚ùå Fout bij herstellen: Ongeldig JSON bestand');
                console.error("Restore error:", error);
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

// AUTO-BACKUP elke 5 minuten
setInterval(() => {
    console.log("Auto-backup check...");
    backupToFile();
}, 5 * 60 * 1000);
        // Voeg hier de rest van je bestaande functies toe...
        // [Alle andere functies uit je vorige code]

        function filterStatus(status) {
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const cards = document.querySelectorAll('.roepnummer-card');
    cards.forEach(card => {
        if (status === 'alle') {
            card.style.display = 'flex';
        } else if (status === 'in' && card.dataset.status === 'in') {
            card.style.display = 'flex';
        } else if (status === 'busy' && card.dataset.status === 'busy') {
            card.style.display = 'flex';
        } else if (status === 'uit' && card.dataset.status === 'uit') {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}
function openStatusModal(roepId) {
    const roep = roepnummers.find(r => r.id === roepId);
    if (!roep) return;
    
    document.getElementById('modalRoepnummer').textContent = 
        `${roep.nummer} - ${roep.naam}`;
    
    selectedRoepnummerId = roepId;
    document.getElementById('statusModal').classList.add('show');
}

function closeModal() {
    document.getElementById('statusModal').classList.remove('show');
    selectedRoepnummerId = null;
}

function changeStatus(newStatus) {
    if (!selectedRoepnummerId) return;
    
    const roepIndex = roepnummers.findIndex(r => r.id === selectedRoepnummerId);
    if (roepIndex === -1) return;
    
    // Update status in roepnummers
    roepnummers[roepIndex].status = newStatus;
    
    // Update status in users
    const userIndex = users.findIndex(u => u.roepnummer === roepnummers[roepIndex].nummer);
    if (userIndex !== -1) {
        users[userIndex].status = newStatus;
    }
    
    // Reload alles
    loadRoepnummers();
    
    // Als dit de huidige dienst is, update de status
    if (huidigeDienst && huidigeDienst.id === selectedRoepnummerId) {
        updateDienstStatus();
    }
    
    closeModal();
    
    // Sla op
    saveToLocalStorage();
    
    let statusText = 'UIT';
    if (newStatus === 'in') statusText = 'VRIJ';
    if (newStatus === 'busy') statusText = 'BEZIG';
    
    alert(`Status gewijzigd: ${roepnummers[roepIndex].nummer} is nu ${statusText}`);
}
function startDienst() {
    const select = document.getElementById('selectRoepnummer');
    const roepId = parseInt(select.value);
    
    if (!roepId) {
        alert('Selecteer eerst een roepnummer!');
        return;
    }
    
    const roep = roepnummers.find(r => r.id === roepId);
    if (!roep) return;
    
    // Zet status op "in" in beide arrays
    roep.status = 'in';
    const userIndex = users.findIndex(u => u.roepnummer === roep.nummer);
    if (userIndex !== -1) {
        users[userIndex].status = 'in';
    }
    
    // Start dienst
    huidigeDienst = roep;
    dienstStartTijd = new Date();
    
    // Update UI
    updateDienstStatus();
    document.getElementById('dienstTimer').classList.add('show');
    document.getElementById('startDienstBtn').disabled = true;
    document.getElementById('stopDienstBtn').disabled = false;
    
    // Start timer
    updateTimer();
    dienstTimer = setInterval(updateTimer, 1000);
    
    // Reload roepnummers
    loadRoepnummers();
    
    // Sla op
    saveToLocalStorage();
    
    alert(`‚úÖ Dienst gestart voor ${roep.nummer}`);
}

async function stopDienst() {
    if (!huidigeDienst) return;
    
    // Bereken duur
    const eindTijd = new Date();
    const duurMs = eindTijd - dienstStartTijd;
    const uren = Math.floor(duurMs / (1000 * 60 * 60));
    const minuten = Math.floor((duurMs % (1000 * 60 * 60)) / (1000 * 60));
    const duur = `${uren} uur ${minuten} min`;
    
    // Stop timer
    clearInterval(dienstTimer);
    
    // Update roepnummer status
    const roepIndex = roepnummers.findIndex(r => r.id === huidigeDienst.id);
    if (roepIndex !== -1) {
        roepnummers[roepIndex].status = 'uit';
    }
    
    // Update user status
    const userIndex = users.findIndex(u => u.roepnummer === huidigeDienst.nummer);
    if (userIndex !== -1) {
        users[userIndex].status = 'uit';
    }
    
    // VERZEND NAAR DISCORD
    if (discordSettings.webhookURL) {
        await sendToDiscord(huidigeDienst.nummer, dienstStartTijd, eindTijd, duur);
    }
    
    // Update UI
    huidigeDienst = null;
    document.getElementById('dienstTimer').classList.remove('show');
    document.getElementById('startDienstBtn').disabled = false;
    document.getElementById('stopDienstBtn').disabled = true;
    
    // Reload
    loadRoepnummers();
    updateDienstStatus();
    
    // Sla op
    saveToLocalStorage();
    
    if (discordSettings.webhookURL) {
        alert(`üõë Dienst be√´indigd\n\nDuur: ${duur}\n‚úÖ Bericht naar Discord verzonden!`);
    } else {
        alert(`üõë Dienst be√´indigd\n\nDuur: ${duur}\n‚ö†Ô∏è Discord webhook niet geconfigureerd`);
    }
}

async function sendToDiscord(roepnummer, starttijd, eindtijd, duur) {
    if (!discordSettings.webhookURL) {
        console.warn('‚ö†Ô∏è Geen Discord webhook geconfigureerd');
        return;
    }
    
    const message = {
        content: `@here üìä **DIENST RAPPORT**`,
        embeds: [{
            title: `üìÖ Dienst be√´indigd: ${roepnummer}`,
            color: 0x2ed573,
            fields: [
                { name: "üè∑Ô∏è Roepnummer", value: roepnummer, inline: true },
                { name: "‚è∞ Starttijd", value: starttijd.toLocaleTimeString('nl-NL'), inline: true },
                { name: "üõë Eindtijd", value: eindtijd.toLocaleTimeString('nl-NL'), inline: true },
                { name: "‚è±Ô∏è Dienstduur", value: duur, inline: true },
                { name: "üë§ Van", value: discordSettings.botNaam, inline: true }
            ],
            timestamp: new Date().toISOString(),
            footer: { text: "GMS Breda - Gemeentelijk Meldingen Systeem" }
        }]
    };

    try {
        const response = await fetch(discordSettings.webhookURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(message)
        });
        
        if (response.ok) {
            console.log('‚úÖ Bericht naar Discord verzonden');
        } else {
            console.error('‚ùå Discord error:', await response.text());
        }
    } catch (error) {
        console.error('‚ùå Netwerk error:', error);
    }
}
function updateDienstStatus() {
    const statusEl = document.getElementById('currentStatus');
    const circleEl = document.getElementById('statusCircle');
    const roepEl = document.getElementById('currentRoepnummer');
    const timerEl = document.getElementById('currentTimer');
    
    if (huidigeDienst) {
        statusEl.textContent = huidigeDienst.status === 'in' ? 'Vrij' : 'Bezig';
        statusEl.style.color = huidigeDienst.status === 'in' ? 'var(--online)' : 'var(--warning)';
        circleEl.className = huidigeDienst.status === 'in' ? 'status-circle online' : 'status-circle busy';
        roepEl.textContent = huidigeDienst.nummer;
        roepEl.style.color = 'var(--accent)';
        timerEl.style.color = 'var(--accent)';
    } else {
        statusEl.textContent = 'Uit Dienst';
        statusEl.style.color = 'var(--offline)';
        circleEl.className = 'status-circle offline';
        roepEl.textContent = '-';
        roepEl.style.color = '#88c1ff';
        timerEl.style.color = '#88c1ff';
    }
}

function updateTimer() {
    if (!dienstStartTijd) return;
    
    const nu = new Date();
    const duurMs = nu - dienstStartTijd;
    const uren = Math.floor(duurMs / (1000 * 60 * 60));
    const minuten = Math.floor((duurMs % (1000 * 60 * 60)) / (1000 * 60));
    const seconden = Math.floor((duurMs % (1000 * 60)) / 1000);
    
    const timerStr = `${uren.toString().padStart(2, '0')}:${minuten.toString().padStart(2, '0')}:${seconden.toString().padStart(2, '0')}`;
    
    document.getElementById('currentTimer').textContent = timerStr;
    
    // Update starttijd display
    const startStr = dienstStartTijd.toLocaleTimeString('nl-NL', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('startTijdDisplay').textContent = startStr;
}
function updateRoepnummerSelect() {
    const select = document.getElementById('selectRoepnummer');
    if (!select) return;
    
    select.innerHTML = '<option value="">Selecteer je roepnummer...</option>';
    
    // Toon alleen roepnummers van ingelogde gebruiker
    if (currentUser) {
        const userRoepnummers = roepnummers.filter(r => 
            r.dienst === currentUser.dienst || currentUser.role === 'admin'
        );
        
        userRoepnummers.forEach(roep => {
            const option = document.createElement('option');
            option.value = roep.id;
            option.textContent = `${roep.nummer} - ${roep.naam} (${getDienstNaam(roep.dienst)})`;
            select.appendChild(option);
        });
        
        // Selecteer roepnummer van ingelogde gebruiker
        const userRoep = roepnummers.find(r => r.nummer === currentUser.roepnummer);
        if (userRoep) {
            select.value = userRoep.id;
        }
    }
}
function loadDiscordKanalen() {
    const container = document.getElementById('discordKanalen');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (discordKanalen.length === 0) {
        container.innerHTML = '<p style="color: #88c1ff; text-align: center; padding: 20px;">Discord kanalen worden hier getoond.<br>Configureer in Discord tab.</p>';
        return;
    }
    
    discordKanalen.forEach(kanaal => {
        const item = document.createElement('div');
        item.className = 'kanaal-item';
        
        item.innerHTML = `
            <div class="kanaal-info">
                <div>${kanaal.naam}</div>
            </div>
            <div class="kanaal-bezetting">${kanaal.nu || 0}/${kanaal.max}</div>
        `;
        
        container.appendChild(item);
    });
}
// ========== DEBUG FUNCTIES ==========
function testLogin() {
    console.log("=== TEST ALLE GEBRUIKERS ===");
    console.log("Aantal gebruikers:", users.length);
    
    users.forEach((user, index) => {
        console.log(`${index + 1}. ${user.email} - ${user.password} - ${user.name}`);
    });
    
    // Toon ook in een alert
    const userList = users.map(u => `${u.email} (${u.name})`).join('\n');
    alert(`Gebruikers in systeem:\n${userList}`);
}

function forceReloadData() {
    if (confirm("Weet je zeker dat je alle data wilt herladen?\n\nDit logt je uit en herlaadt alles.")) {
        localStorage.removeItem('gms_data');
        localStorage.removeItem('gms_currentUser');
        location.reload();
    }
}

// Voeg ook deze knop toe in footer:
// <button onclick="forceReloadData()" class="action-btn secondary">üîÑ Force Reload</button>
    // ======================
    // AUTO-SYNC VOOR MELDINGEN
    // ======================
    
    // Auto-sync meldingen elke 30 seconden
setInterval(() => {
  if (currentUser && currentUser.role === 'admin') {
    // Gebruik getAPIUrl helper
    loadMeldingenFromAPI();
  }
}, 30000);
    
    
    // Voeg de testMeldingenAPI functie hier toe (binnen dezelfde <script> tag)
async function testMeldingenAPI() {
  try {
    // VERANDER HIER:
    const response = await fetch(getAPIUrl('/get-meldingen'));
    const data = await response.json();
    
    console.log("üìä API Response:", data);
    
    alert(`‚úÖ API werkt!\nGebruikers: ${data.users?.length || 0}\nMeldingen: ${data.meldingen?.length || 0}`);
    
  } catch (error) {
    console.error("‚ùå API test failed:", error);
    alert(`‚ùå API test mislukt:\n${error.message}`);
  }
}
// Test Supabase connectie
async function testSupabaseConnection() {
  try {
    console.log('üîó Test Supabase connectie...');
    const response = await fetch(getAPIUrl('/sync-users'));
    const data = await response.json();
    
    if (data.success) {
      console.log(`‚úÖ Supabase werkt! ${data.users?.length || 0} spelers gevonden`);
      return true;
    } else {
      console.error('‚ùå API error:', data.error);
      return false;
    }
  } catch (error) {
    console.error('‚ùå Netwerk error:', error);
    return false;
  }
}

// Test bij opstarten
setTimeout(() => {
  if (currentUser) {
    testSupabaseConnection();
  }
}, 2000);
    </script>
</body>
</html>

